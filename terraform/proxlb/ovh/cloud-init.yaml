#cloud-config

# System update and package installation
package_update: true
package_upgrade: true

packages:
  - curl
  - wget
  - git
  - vim
  - htop
  - net-tools
  - ca-certificates
  - gnupg
  - lsb-release

# Docker group configuration
groups:
  - docker

system_info:
  default_user:
    groups: [docker, sudo]

# Write docker-compose.yml
write_files:
  - path: /opt/proxlb/docker-compose.yml
    permissions: '0644'
    encoding: b64
    content: ${docker_compose_config}

  - path: /opt/proxlb/.env
    permissions: '0600'
    owner: debian:debian
    content: |
      # ProxLB Environment Variables
      # Edit this file with your actual values

      # DNS Configuration
      # If you only use one DNS server, leave DNS_SERVER2 empty
      DNS_SERVER1=${dns_server1}
      DNS_SERVER2=${dns_server2}
      DNS_DOMAIN=${dns_domain}
      DNS_SEARCH=${dns_search}

      # Proxmox Authentication
      PROXMOX_USER=${proxmox_user}
      PROXMOX_TOKEN_NAME=${proxmox_token_name}

      # Proxmox Nodes Configuration
      ${proxmox_nodes_env}

  - path: /opt/proxlb/proxlb.yaml.template
    permissions: '0644'
    encoding: b64
    content: ${proxlb_config}

  - path: /opt/proxlb/configure-dns.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      # Configure DNS using traditional /etc/resolv.conf
      source /opt/proxlb/.env

      echo "Disabling systemd-resolved and configuring traditional DNS..."

      # Stop and disable systemd-resolved
      systemctl stop systemd-resolved
      systemctl disable systemd-resolved

      # Remove the systemd-resolved stub resolver
      rm -f /etc/resolv.conf

      # Create a new /etc/resolv.conf with our DNS settings
      cat > /etc/resolv.conf <<DNSEOF
      # DNS Configuration for ProxLB
      # Internal DNS server for Proxmox name resolution
      nameserver $${DNS_SERVER1}
      DNSEOF

      # Add second DNS server only if configured
      if [ -n "$${DNS_SERVER2}" ]; then
        echo "nameserver $${DNS_SERVER2}" >> /etc/resolv.conf
      fi

      # Add search and domain
      cat >> /etc/resolv.conf <<DNSEOF
      search $${DNS_SEARCH}
      domain $${DNS_DOMAIN}
      DNSEOF

      # Make resolv.conf immutable to prevent DHCP from overwriting it
      chattr +i /etc/resolv.conf

      echo "DNS configured successfully!"
      echo "Content of /etc/resolv.conf:"
      cat /etc/resolv.conf
      echo ""
      echo "Testing DNS resolution with first Proxmox node..."
      if [ -n "$${PROXMOX_NODE1_HOST}" ]; then
        nslookup $${PROXMOX_NODE1_HOST} || echo "Warning: DNS test failed for $${PROXMOX_NODE1_HOST}"
      fi

  - path: /opt/proxlb/generate-config.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      # Generate proxlb.yaml from template using envsubst
      set -a
      source /opt/proxlb/.env
      set +a
      envsubst < /opt/proxlb/proxlb.yaml.template > /opt/proxlb/proxlb.yaml
      echo "Configuration generated from template"

  - path: /opt/proxlb/start.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      cd /opt/proxlb
      docker compose pull
      docker compose up -d
      echo "ProxLB started successfully"

  - path: /opt/proxlb/stop.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      cd /opt/proxlb
      docker compose down
      echo "ProxLB stopped successfully"

  - path: /opt/proxlb/restart.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      cd /opt/proxlb
      docker compose restart
      echo "ProxLB restarted successfully"

  - path: /opt/proxlb/logs.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      cd /opt/proxlb
      docker compose logs -f

  - path: /etc/systemd/system/proxlb.service
    permissions: '0644'
    content: |
      [Unit]
      Description=ProxLB Load Balancer
      Requires=docker.service
      After=docker.service

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      WorkingDirectory=/opt/proxlb
      ExecStart=/usr/bin/docker compose up -d
      ExecStop=/usr/bin/docker compose down
      TimeoutStartSec=0

      [Install]
      WantedBy=multi-user.target

# Run commands after system is configured
runcmd:
  # Install Docker from official repository
  - mkdir -p /etc/apt/keyrings
  - curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
  - chmod a+r /etc/apt/keyrings/docker.gpg
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
  - systemctl enable docker
  - systemctl start docker
  - apt-get install -y gettext-base  # Install envsubst for template substitution
  - mkdir -p /var/log/proxlb
  - usermod -aG docker debian
  - chown -R debian:debian /opt/proxlb
  - chmod +x /opt/proxlb/*.sh
  - /opt/proxlb/configure-dns.sh  # Configure DNS from .env file
  - /opt/proxlb/generate-config.sh  # Generate proxlb.yaml from template and .env
  - sleep 5
  - cd /opt/proxlb && docker compose pull
  - systemctl daemon-reload
  - systemctl enable proxlb.service
  - systemctl start proxlb.service
  - echo "ProxLB installation completed" > /var/log/cloud-init-complete.log

# Set timezone
timezone: Europe/Madrid

# Final message
final_message: |
  ProxLB instance is ready!

  Docker Compose location: /opt/proxlb/
  Configuration file: /opt/proxlb/proxlb.yaml

  Useful commands:
    - Start ProxLB: /opt/proxlb/start.sh or systemctl start proxlb
    - Stop ProxLB: /opt/proxlb/stop.sh or systemctl stop proxlb
    - Restart ProxLB: /opt/proxlb/restart.sh or systemctl restart proxlb
    - View logs: /opt/proxlb/logs.sh or docker logs proxlb
    - Check status: systemctl status proxlb

  Edit the configuration file and restart the service to apply changes.

  System initialization completed in $UPTIME seconds.
