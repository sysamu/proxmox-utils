alias sites='cd /etc/nginx/sites-enabled'

gensitecert() {
    DOMAIN="$1"
    UPSTREAM="$2"
    PORT="${3:-80}"

    # Validaciones b√°sicas
    if [ -z "$DOMAIN" ] || [ -z "$UPSTREAM" ]; then
        echo "‚ùå Error: faltan par√°metros."
        echo ""
        echo "Uso:"
        echo "  gensitecert <subdominio> <proxy_pass_host> [proxy_port]"
        echo ""
        echo "Ejemplos:"
        echo "  gensitecert subdomain.example.com upstream.example.com"
        echo "  gensitecert api.example.com backend.example.com 8080"
        return 1
    fi

    TEMPLATE="/etc/nginx/templates/nginx-subdomain"

    # Verificar que la plantilla existe
    if [ ! -f "$TEMPLATE" ]; then
        echo "‚ùå Error: plantilla Nginx no encontrada en $TEMPLATE"
        echo "Por favor, crea la plantilla antes de continuar."
        echo "Ejemplo m√≠nimo de plantilla:"
        echo "server {"
        echo "    server_name __DOMAIN__;"
        echo "    location / {"
        echo "        proxy_pass http://__UPSTREAM__/;"
        echo "    }"
        echo "}"
        return 1
    fi

    TARGET="/etc/nginx/sites-enabled/$DOMAIN"
    DOMAIN_SAFE=$(echo "$DOMAIN" | tr '.' '_')

    echo "‚û°Ô∏è  Generando configuraci√≥n Nginx‚Ä¶"

    sed -e "s/__DOMAIN__/$DOMAIN/g" \
        -e "s/__DOMAIN_SAFE__/$DOMAIN_SAFE/g" \
        -e "s#__UPSTREAM__#$UPSTREAM:$PORT#g" \
        "$TEMPLATE" > "$TARGET"

    echo "‚úî Configuraci√≥n creada en: $TARGET"

    echo "‚û°Ô∏è  Obteniendo certificado con DNS Cloudflare‚Ä¶"
    echo 2 | certbot certonly --force-renewal --dns-cloudflare \
        --dns-cloudflare-credentials /etc/nginx/.secrets/certbot/cloudflare.ini \
        --dns-cloudflare-propagation-seconds 10 \
        -d "$DOMAIN"

    if [ $? -ne 0 ]; then
        echo "‚ùå Certbot DNS fall√≥. Abortando."
        return 1
    fi

    echo "‚û°Ô∏è  Aplicando certificado al site con plugin nginx‚Ä¶"
    echo 1 | certbot --nginx -d "$DOMAIN"

    if [ $? -ne 0 ]; then
        echo "‚ùå Error aplicando el certificado. Revisa certbot."
        return 1
    fi

    echo "‚û°Ô∏è  Recargando Nginx‚Ä¶"
    nginx -t && systemctl restart nginx

    echo ""
    echo "üéâ Todo listo!"
    echo "    Site: /etc/nginx/sites-available/$DOMAIN"
    echo "    URL:  https://$DOMAIN"
}

genwsscert() {
    DOMAIN="$1"
    UPSTREAM="$2"
    PORT="${3:-8080}"

    # Validaciones
    if [ -z "$DOMAIN" ] || [ -z "$UPSTREAM" ]; then
        echo "‚ùå Error: faltan par√°metros."
        echo ""
        echo "Uso:"
        echo "  genwsscert <subdominio> <upstream_name> [proxy_port]"
        echo ""
        echo "Ejemplos:"
        echo "  genwsscert wss.example.com upstream_ws 8080"
        return 1
    fi

    TEMPLATE="/etc/nginx/templates/nginx-wss"
    TARGET="/etc/nginx/sites-enabled/$DOMAIN"
    DOMAIN_SAFE=$(echo "$DOMAIN" | tr '.' '_')

    if [ ! -f "$TEMPLATE" ]; then
        echo "‚ùå Error: plantilla Nginx no encontrada en $TEMPLATE"
        return 1
    fi

    echo "‚û°Ô∏è  Generando configuraci√≥n Nginx WSS‚Ä¶"
    sed -e "s/__DOMAIN__/$DOMAIN/g" \
        -e "s/__DOMAIN_SAFE__/$DOMAIN_SAFE/g" \
        -e "s|__UPSTREAM__:__PORT__|$UPSTREAM:$PORT|g" \
        "$TEMPLATE" > "$TARGET"
    echo "‚úî Configuraci√≥n creada en: $TARGET"

    echo "‚û°Ô∏è  Solicitando certificado DNS Cloudflare‚Ä¶"
    echo 1 | certbot certonly --dns-cloudflare \
        --dns-cloudflare-credentials /etc/nginx/.secrets/certbot/cloudflare.ini \
        --dns-cloudflare-propagation-seconds 10 \
        -d "$DOMAIN"

    if [ $? -ne 0 ]; then
        echo "‚ùå Certbot DNS fall√≥. Abortando."
        return 1
    fi

    echo "‚û°Ô∏è  Descomentando l√≠neas de certificado en la config‚Ä¶"
    sed -i \
        -e "s|^[[:space:]]*# ssl_certificate /etc/letsencrypt/live/$DOMAIN/fullchain.pem;|ssl_certificate /etc/letsencrypt/live/$DOMAIN/fullchain.pem;|" \
        -e "s|^[[:space:]]*# ssl_certificate_key /etc/letsencrypt/live/$DOMAIN/privkey.pem;|ssl_certificate_key /etc/letsencrypt/live/$DOMAIN/privkey.pem;|" \
        "$TARGET"

    echo "‚û°Ô∏è  Recargando Nginx‚Ä¶"
    nginx -t && systemctl restart nginx

    echo ""
    echo "üéâ Todo listo!"
    echo "    Site: $TARGET"
    echo "    URL:  https://$DOMAIN"
}
